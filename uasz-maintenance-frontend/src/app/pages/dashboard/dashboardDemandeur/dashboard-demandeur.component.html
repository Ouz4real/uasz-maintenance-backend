<!-- src/app/pages/dashboard/dashboardDemandeur/dashboard-demandeur.component.html -->

<div class="dashboard-layout">

  <!-- ========== SIDEBAR ========== -->
  <aside class="sidebar">

    <!-- Header -->
    <div class="sidebar-header">
      <div class="avatar-circle">{{ usernameInitial }}</div>
      <div class="sidebar-title">
        <h1>Maintenance UASZ</h1>
        <p>Parc & interventions</p>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="sidebar-nav">

      <!-- Tableau de bord -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'dashboard'"
        (click)="setActive('dashboard')"
      >
        <span class="nav-icon material-icons">dashboard</span>
        <span class="nav-label">Tableau de bord</span>
      </button>

      <!-- Mes demandes -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'mes-demandes'"
        (click)="setActive('mes-demandes')"
      >
        <span class="nav-icon material-icons">build</span>
        <span class="nav-label">Mes demandes</span>
      </button>

      <!-- Documents -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'documents'"
        (click)="setActive('documents')"
      >
        <span class="nav-icon material-icons">description</span>
        <span class="nav-label">Documents</span>
      </button>

      <!-- Aide & support -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'aide'"
        (click)="setActive('aide')"
      >
        <span class="nav-icon material-icons">help</span>
        <span class="nav-label">Aide & support</span>
      </button>

    </nav>

  </aside>

  <!-- ========== MAIN ========== -->
  <main class="main">

    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-left">
        <h2>Tableau de bord ¬∑ Demandeur</h2>
        <p>Suivi de vos demandes de maintenance.</p>
      </div>
      <div class="topbar-right">
        <!-- Bouton rond avec les 3 bandes horizontales -->
        <button
          class="topbar-menu-btn"
          (click)="toggleUserMenu()"
          aria-label="Menu utilisateur"
        >
          <!-- Ic√¥ne toujours en "menu" (pas de croix) -->
          <span class="material-icons">menu</span>
        </button>

        <!-- Overlay clic ext√©rieur pour fermer le menu -->
        <div
          class="user-menu-overlay"
          *ngIf="userMenuOpen"
          (click)="closeUserMenu()"
        ></div>

        <!-- MENU UTILISATEUR -->
        <div *ngIf="userMenuOpen" class="user-menu">

          <div class="user-menu-header">
            <div class="menu-avatar">{{ usernameInitial }}</div>
            <div>
              <div class="menu-name">{{ username }}</div>
              <div class="menu-role">demandeur</div>
            </div>
          </div>

          <div class="user-menu-body">

            <button class="menu-item" (click)="goToDashboard()">
              <span class="menu-icon material-icons">dashboard</span>
              Tableau de bord
            </button>

            <button class="menu-item" (click)="openProfile()">
              <span class="menu-icon material-icons">person</span>
              Mon profil
            </button>


          </div>

          <div class="user-menu-footer">
            <button class="menu-item logout" (click)="logout()">
              <span class="menu-icon material-icons">logout</span>
              Se d√©connecter
            </button>
          </div>

        </div>

      </div>

    </div>

    <!-- ========== CONTENU PRINCIPAL (SCROLLABLE) ========== -->
    <div class="content">

      <!-- üü¶ PAGE : DASHBOARD -->
      <ng-container *ngIf="activeItem === 'dashboard'">

        <!-- Welcome -->
        <div class="welcome-card">
          <h1>Bienvenue, {{ username }}</h1>
          <p>Voici votre espace de suivi des demandes de maintenance.</p>
        </div>

        <!-- Statistiques -->
        <div class="stats-row">

          <div class="stat-card">
            <h3>En attente</h3>
            <p>Demandes non encore prises en charge.</p>
            <div class="stat-value">{{ enAttente }}</div>
          </div>

          <div class="stat-card">
            <h3>En cours de traitement</h3>
            <p>Demandes actuellement trait√©es.</p>
            <div class="stat-value">{{ enCours }}</div>
          </div>

          <div class="stat-card">
            <h3>R√©solues</h3>
            <p>Demandes cl√¥tur√©es avec succ√®s.</p>
            <div class="stat-value">{{ resolues }}</div>
          </div>

        </div>

        <!-- Demandes r√©centes -->
        <div class="recent-requests">
          <div class="recent-header">
            <h2>Mes demandes r√©centes</h2>
          </div>

          <div class="requests-list">
            <div
              *ngFor="let d of demandes"
              class="request-item request-clickable"
              (click)="openDemandeDetails(d)"
            >
              <div>
                <h3 class="request-title">{{ d.titre }}</h3>
                <p class="request-meta">
                  Cr√©√©e le {{ d.dateCreation | date:'yyyy-MM-dd' }} ¬∑ {{ d.lieu }}
                </p>
              </div>

              <div class="request-right">
                <span
                  class="status-chip"
                  [ngClass]="{
                    'pending': d.statut === 'EN_ATTENTE',
                    'progress': d.statut === 'EN_COURS',
                    'done': d.statut === 'RESOLUE'
                  }"
                >
                  {{
                    d.statut === 'EN_ATTENTE' ? 'En attente' :
                      d.statut === 'EN_COURS' ? 'En cours' :
                        'R√©solue'
                  }}
                </span>
              </div>

            </div>
          </div>
        </div>

      </ng-container>

      <!-- üü¶ PAGE : MES DEMANDES -->
      <ng-container *ngIf="activeItem === 'mes-demandes'">

        <div class="recent-requests">
          <div class="recent-header">
            <h2>Toutes mes demandes</h2>
            <button class="primary-btn" (click)="openNewDemandeModal()">
              Nouvelle demande de panne
            </button>
          </div>

          <!-- üîç Filtres statut / urgence / recherche -->
          <div class="filters-card">
            <!-- Ligne statuts -->
            <div class="filters-row status-row">
              <button
                class="filter-chip"
                [class.active]="statutFilter === 'TOUTES'"
                (click)="setStatutFilter('TOUTES')"
              >
                <span class="status-dot dot-all"></span>
                <span>Toutes ({{ demandes.length }})</span>
              </button>

              <button
                class="filter-chip"
                [class.active]="statutFilter === 'EN_ATTENTE'"
                (click)="setStatutFilter('EN_ATTENTE')"
              >
                <span class="status-dot dot-pending"></span>
                <span>En attente ({{ enAttente }})</span>
              </button>

              <button
                class="filter-chip"
                [class.active]="statutFilter === 'EN_COURS'"
                (click)="setStatutFilter('EN_COURS')"
              >
                <span class="status-dot dot-progress"></span>
                <span>En cours ({{ enCours }})</span>
              </button>

              <button
                class="filter-chip"
                [class.active]="statutFilter === 'RESOLUE'"
                (click)="setStatutFilter('RESOLUE')"
              >
                <span class="status-dot dot-done"></span>
                <span>R√©solues ({{ resolues }})</span>
              </button>
            </div>

            <!-- Ligne urgences + recherche -->
            <div class="filters-row urgency-row">
              <div class="urg-left">
                <span class="urg-label">Urgence :</span>

                <div class="urg-chips">
                  <button
                    class="filter-chip"
                    [class.active]="urgenceFilter === 'TOUTES'"
                    (click)="setUrgenceFilter('TOUTES')"
                  >
                    Toutes
                  </button>

                  <button
                    class="filter-chip"
                    [class.active]="urgenceFilter === 'BASSE'"
                    (click)="setUrgenceFilter('BASSE')"
                  >
                    Basse
                  </button>

                  <button
                    class="filter-chip"
                    [class.active]="urgenceFilter === 'MOYENNE'"
                    (click)="setUrgenceFilter('MOYENNE')"
                  >
                    Moyenne
                  </button>

                  <button
                    class="filter-chip"
                    [class.active]="urgenceFilter === 'HAUTE'"
                    (click)="setUrgenceFilter('HAUTE')"
                  >
                    Haute
                  </button>
                </div>
              </div>

              <div class="filters-search">
                <div class="search-wrapper">
                  <span class="material-icons search-icon">search</span>
                  <input
                    type="text"
                    placeholder="Rechercher par titre, lieu, statut..."
                    [(ngModel)]="searchTerm"
                    (ngModelChange)="onSearchChange($event)"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="requests-list">
            <div
              *ngFor="let d of pagedDemandes"
              class="request-item request-clickable"
              (click)="openDemandeDetails(d)"
            >
              <div>
                <h3 class="request-title">{{ d.titre }}</h3>
                <p class="request-meta">
                  Cr√©√©e le {{ d.dateCreation | date:'yyyy-MM-dd' }} ¬∑ {{ d.lieu }}
                </p>
              </div>

              <div class="request-right">
                <span
                  class="status-chip"
                  [ngClass]="{
                    'pending': d.statut === 'EN_ATTENTE',
                    'progress': d.statut === 'EN_COURS',
                    'done': d.statut === 'RESOLUE'
                  }"
                >
                  {{
                    d.statut === 'EN_ATTENTE' ? 'En attente' :
                      d.statut === 'EN_COURS' ? 'En cours' :
                        'R√©solue'
                  }}
                </span>
              </div>

            </div>
          </div>

          <!-- üî¢ Pagination -->
          <div
            class="pagination-bar"
            *ngIf="filteredDemandes.length > pageSize"
          >
            <div class="pagination-info">
              Page {{ currentPage }} sur {{ totalPages }}
            </div>

            <div class="pagination-actions">
              <button
                class="secondary-btn pagination-btn"
                (click)="goToPreviousPage()"
                [disabled]="currentPage === 1"
              >
                Pr√©c√©dent
              </button>

              <button
                class="secondary-btn pagination-btn"
                (click)="goToNextPage()"
                [disabled]="currentPage === totalPages"
              >
                Suivant
              </button>
            </div>
          </div>

        </div>

      </ng-container>

      <!-- üü¶ PAGE : MON PROFIL -->
      <ng-container *ngIf="activeItem === 'profil'">
        <!-- Header profil -->
        <div class="profile-page-header">
          <div>
            <h2>Mon profil</h2>
            <p>
              G√©rez vos informations personnelles et les param√®tres de votre compte Demandeur.
            </p>
          </div>

          <button
            class="secondary-btn profile-back-btn"
            type="button"
            (click)="setActive('dashboard')"
          >
            <span class="material-icons">arrow_back</span>
            Retour au tableau de bord
          </button>
        </div>

        <!-- Grille principale : infos perso + r√¥le -->
        <div class="profile-grid">
          <!-- Carte informations personnelles -->
          <div class="profile-card">
            <h3 class="profile-card-title">Informations personnelles</h3>
            <p class="profile-card-subtitle">
              Ces informations permettent d‚Äôidentifier le demandeur dans l‚Äôapplication.
            </p>

            <div class="form-grid profile-form-grid">
              <div class="form-field">
                <label for="profilNom">Nom</label>
                <input
                  id="profilNom"
                  type="text"
                  [(ngModel)]="profilForm.nom"
                  placeholder="Ex : Man√©"
                />
              </div>

              <div class="form-field">
                <label for="profilPrenom">Pr√©nom</label>
                <input
                  id="profilPrenom"
                  type="text"
                  [(ngModel)]="profilForm.prenom"
                  placeholder="Ex : Ousmane"
                />
              </div>

              <div class="form-field">
                <label for="profilEmail">Adresse e-mail</label>
                <input
                  id="profilEmail"
                  type="email"
                  [(ngModel)]="profilForm.email"
                  placeholder="Ex : demandeur@uasz.sn"
                />
              </div>

              <div class="form-field">
                <label for="profilTelephone">T√©l√©phone</label>
                <input
                  id="profilTelephone"
                  type="text"
                  [(ngModel)]="profilForm.telephone"
                  placeholder="Ex : +221 77 000 00 00"
                />
              </div>

              <div class="form-field">
                <label for="profilService">Service / Unit√©</label>
                <input
                  id="profilService"
                  type="text"
                  [(ngModel)]="profilForm.service"
                  placeholder="Ex : UFR Sciences et Technologies"
                />
              </div>

              <div class="form-field">
                <label for="profilDepartement">D√©partement / Fili√®re</label>
                <input
                  id="profilDepartement"
                  type="text"
                  [(ngModel)]="profilForm.departement"
                  placeholder="Ex : D√©partement Informatique"
                />
              </div>
            </div>

            <div class="profile-actions-row">
              <button
                type="button"
                class="secondary-btn"
                (click)="resetProfilForm()"
              >
                R√©initialiser
              </button>
              <button
                type="button"
                class="primary-btn"
                (click)="enregistrerProfil()"
              >
                Enregistrer les modifications
              </button>
            </div>
          </div>

          <!-- Carte r√¥le et compte -->
          <div class="profile-card profile-summary-card">
            <h3 class="profile-card-title">R√¥le et compte</h3>
            <p class="profile-card-subtitle">
              R√©sum√© de votre r√¥le dans le syst√®me de maintenance UASZ.
            </p>

            <div class="profile-user-block">
              <div class="profile-user-avatar">
                {{ usernameInitial }}
              </div>
              <div>
                <div class="profile-user-label">Utilisateur</div>
                <div class="profile-user-email">
                  {{ profilForm.email }}
                </div>
                <div class="profile-role-line">
                  <span class="profile-role-chip">
                    DEMANDEUR
                  </span>
                </div>
              </div>
            </div>

            <ul class="profile-role-list">
              <li>
                <span class="material-icons profile-role-icon">assignment</span>
                Cr√©er des demandes de maintenance pour les √©quipements utilis√©s.
              </li>
              <li>
                <span class="material-icons profile-role-icon">visibility</span>
                Suivre l‚Äôavancement des demandes (en attente, en cours, r√©solues).
              </li>
              <li>
                <span class="material-icons profile-role-icon">schedule</span>
                Relancer une demande si elle reste en attente trop longtemps.
              </li>
              <li>
                <span class="material-icons profile-role-icon">email</span>
                Recevoir des notifications li√©es aux interventions sur vos demandes.
              </li>
            </ul>
          </div>
        </div>

        <!-- Carte s√©curit√© -->
        <div class="profile-card profile-security-card">
          <h3 class="profile-card-title">S√©curit√© & mot de passe</h3>
          <p class="profile-card-subtitle">
            Modifiez r√©guli√®rement votre mot de passe pour s√©curiser votre compte.
          </p>

          <div class="form-grid profile-form-grid">
            <div class="form-field form-full">
              <label for="profilOldPwd">Mot de passe actuel</label>
              <input
                id="profilOldPwd"
                type="password"
                [(ngModel)]="profilForm.motDePasseActuel"
                placeholder="Saisissez votre mot de passe actuel"
              />
            </div>

            <div class="form-field">
              <label for="profilNewPwd">Nouveau mot de passe</label>
              <input
                id="profilNewPwd"
                type="password"
                [(ngModel)]="profilForm.nouveauMotDePasse"
                placeholder="Nouveau mot de passe"
              />
            </div>

            <div class="form-field">
              <label for="profilConfirmPwd">Confirmation</label>
              <input
                id="profilConfirmPwd"
                type="password"
                [(ngModel)]="profilForm.confirmationMotDePasse"
                placeholder="Confirmez le nouveau mot de passe"
              />
            </div>
          </div>

          <div class="profile-actions-row">
            <button
              type="button"
              class="primary-btn"
              (click)="enregistrerProfil()"
            >
              Mettre √† jour le mot de passe
            </button>
          </div>

          <!-- TODO: plus tard, on branchera sur une API :
               this.authService.changePassword(...).subscribe(...) -->
        </div>
      </ng-container>


      <!-- üü¶ PAGE : DOCUMENTS -->
      <ng-container *ngIf="activeItem === 'documents'">
        <div class="recent-requests">
          <div class="recent-header">
            <h2>Mes documents</h2>
          </div>

          <!-- Filtres documents -->
          <div class="filters-card docs-filters">
            <div class="filters-row">
              <button
                class="filter-chip"
                [class.active]="docTypeFilter === 'TOUS'"
                (click)="setDocTypeFilter('TOUS')"
              >
                Tous ({{ documents.length }})
              </button>

              <button
                class="filter-chip"
                [class.active]="docTypeFilter === 'IMAGE'"
                (click)="setDocTypeFilter('IMAGE')"
              >
                Images
              </button>

              <button
                class="filter-chip"
                [class.active]="docTypeFilter === 'PDF'"
                (click)="setDocTypeFilter('PDF')"
              >
                PDF
              </button>

              <button
                class="filter-chip"
                [class.active]="docTypeFilter === 'RAPPORT'"
                (click)="setDocTypeFilter('RAPPORT')"
              >
                Rapports
              </button>

              <button
                class="filter-chip"
                [class.active]="docTypeFilter === 'AUTRE'"
                (click)="setDocTypeFilter('AUTRE')"
              >
                Autres
              </button>
            </div>

            <div class="filters-row docs-search-row">
              <div class="filters-search">
                <div class="search-wrapper">
                  <span class="material-icons search-icon">search</span>
                  <input
                    type="text"
                    placeholder="Rechercher par nom de document ou demande‚Ä¶"
                    [(ngModel)]="docSearchTerm"
                    (ngModelChange)="onDocSearchChange($event)"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Liste des documents -->
          <div class="requests-list" *ngIf="filteredDocuments.length > 0; else noDocs">
            <div
              *ngFor="let doc of filteredDocuments"
              class="request-item document-item"
            >
              <div class="document-left">
                <div class="document-icon">
                  <span class="material-icons">
                    {{ doc.type === 'IMAGE' ? 'image'
                    : doc.type === 'PDF' ? 'picture_as_pdf'
                      : doc.type === 'RAPPORT' ? 'description'
                        : 'insert_drive_file' }}
                  </span>
                </div>
                <div>
                  <h3 class="request-title">{{ doc.nom }}</h3>
                  <p class="request-meta">
                    Li√© √† :
                    <button
                      class="link-unstyled"
                      type="button"
                      (click)="allerVersDemande(doc)"
                    >
                      {{ doc.demandeTitre }}
                    </button>
                    ¬∑ D√©pos√© le {{ doc.dateDepot | date:'yyyy-MM-dd' }}
                    <span *ngIf="doc.taille"> ¬∑ {{ doc.taille }}</span>
                  </p>
                </div>
              </div>

              <div class="document-right">
                <span
                  class="doc-type-chip"
                  [ngClass]="{
                    'doc-image': doc.type === 'IMAGE',
                    'doc-pdf': doc.type === 'PDF',
                    'doc-rapport': doc.type === 'RAPPORT',
                    'doc-autre': doc.type === 'AUTRE'
                  }"
                >
                  {{ doc.type === 'IMAGE' ? 'Image'
                  : doc.type === 'PDF' ? 'PDF'
                    : doc.type === 'RAPPORT' ? 'Rapport'
                      : 'Autre' }}
                </span>

                <button
                  class="secondary-btn small"
                  type="button"
                  (click)="ouvrirDocument(doc)"
                  [disabled]="!doc.url"
                  title="T√©l√©charger ou ouvrir le document"
                >
                  {{ doc.url ? 'Ouvrir' : 'T√©l√©chargement bient√¥t' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Aucun document -->
          <ng-template #noDocs>
            <div class="docs-empty-state">
              <p class="docs-empty-title">Aucun document disponible pour le moment</p>
              <p class="docs-empty-text">
                Les documents appara√Ætront ici lorsque vous ajouterez des images
                √† vos demandes ou que l‚Äô√©quipe maintenance d√©posera des rapports.
              </p>
            </div>
          </ng-template>
        </div>
      </ng-container>



      <!-- üü¶ PAGE : AIDE & SUPPORT (am√©lior√©e) -->
      <ng-container *ngIf="activeItem === 'aide'">
        <div class="recent-requests">
          <div class="recent-header">
            <h2>Aide & support</h2>
            <p class="section-subtitle">
              Retrouvez ici des r√©ponses rapides sur la cr√©ation, le suivi, la relance et les
              pi√®ces jointes (images) de vos demandes.
            </p>
          </div>

          <div class="help-grid">
            <!-- Colonne gauche : FAQ rapide -->
            <div class="help-column">
              <div class="help-section-title">
                <span class="material-icons help-icon">help_outline</span>
                <div>
                  <h3>Questions fr√©quentes</h3>
                  <p>Quelques r√©ponses rapides avant de contacter le support.</p>
                </div>
              </div>

              <div class="help-faq-list">
                <div class="request-item help-item">
                  <div>
                    <h3 class="request-title">Comment cr√©er une nouvelle demande ?</h3>
                    <p class="request-meta">
                      Depuis votre tableau de bord ou l‚Äôonglet <strong>‚ÄúMes demandes‚Äù</strong>,
                      cliquez sur <strong>‚ÄúNouvelle demande de panne‚Äù</strong>, renseignez les champs
                      obligatoires (<strong>titre</strong>, <strong>lieu</strong>, <strong>type d‚Äô√©quipement</strong>,
                      <strong>urgence</strong>) puis ajoutez une <strong>image de l‚Äô√©quipement</strong> (obligatoire).
                      Le bouton <strong>‚ÄúEnregistrer la demande‚Äù</strong> s‚Äôactive uniquement si tout est valide.
                    </p>
                  </div>
                </div>

                <div class="request-item help-item">
                  <div>
                    <h3 class="request-title">Comment suivre l‚Äôavancement d‚Äôune demande ?</h3>
                    <p class="request-meta">
                      Le statut de chaque demande (<em>En attente</em>, <em>En cours</em>, <em>R√©solue</em>)
                      est visible dans vos listes. Cliquez sur une demande pour voir le d√©tail (infos + image)
                      et, si besoin, <strong>la relancer</strong> lorsqu‚Äôelle est bloqu√©e trop longtemps.
                    </p>
                  </div>
                </div>

                <!-- üÜï FAQ sp√©cifique sur la relance -->
                <div class="request-item help-item">
                  <div>
                    <h3 class="request-title">Comment relancer une demande en attente ?</h3>
                    <p class="request-meta">
                      Ouvrez l‚Äôonglet <strong>‚ÄúMes demandes‚Äù</strong>, cliquez sur la demande concern√©e
                      (statut <em>En attente</em>), puis utilisez le bouton
                      <strong>‚ÄúRelancer cette demande‚Äù</strong> dans la fen√™tre de d√©tails.
                      (Le bouton devient actif apr√®s une certaine dur√©e d‚Äôattente, par exemple 5 jours.)
                    </p>
                  </div>
                </div>

                <div class="request-item help-item">
                  <div>
                    <h3 class="request-title">Quand utiliser l‚Äôurgence ‚ÄúHaute‚Äù ?</h3>
                    <p class="request-meta">
                      Utilisez l‚Äôurgence <strong>Haute</strong> uniquement si la panne bloque un cours,
                      un examen ou une activit√© critique (salle de TP, serveur p√©dagogique, etc.).
                      Sinon, privil√©giez <strong>Basse</strong> ou <strong>Moyenne</strong>.
                    </p>
                  </div>
                </div>

                <div class="request-item help-item">
                  <div>
                    <h3 class="request-title">Et si mon √©quipement n‚Äôest pas dans la liste ?</h3>
                    <p class="request-meta">
                      S√©lectionnez <strong>‚ÄúAutre‚Äù</strong> puis pr√©cisez le nom de l‚Äô√©quipement.
                      Exemple : <em>‚ÄúAUTRE: Robinet ‚Äì Couloir C03‚Äù</em>. Votre demande reste valide.
                    </p>
                  </div>
                </div>

                <div class="request-item help-item">
                  <div>
                    <h3 class="request-title">Pourquoi mon image est refus√©e ?</h3>
                    <p class="request-meta">
                      Certaines images peuvent √™tre trop volumineuses. Si un message en rouge s‚Äôaffiche sous le champ
                      ‚ÄúImage de l‚Äô√©quipement‚Äù, choisissez une image plus l√©g√®re (ou compressez-la) puis r√©essayez.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Colonne droite : contact / support -->
            <div class="help-column help-column-right">
              <div class="help-support-card">
                <h3>Besoin d‚Äôun coup de main ?</h3>
                <p class="request-meta">
                  Si vous ne trouvez pas la r√©ponse √† votre question, vous pouvez contacter l‚Äô√©quipe maintenance
                  ou cr√©er directement une nouvelle demande.
                </p>

                <div class="help-contact-block">
                  <div class="help-contact-line">
                    <span class="material-icons">email</span>
                    <span>maintenance@uasz.sn</span>
                  </div>
                  <div class="help-contact-line">
                    <span class="material-icons">phone</span>
                    <span>+221 77 123 45 67</span>
                  </div>
                  <div class="help-contact-line">
                    <span class="material-icons">schedule</span>
                    <span>Lundi ‚Äì Vendredi, 8h00 ‚Äì 17h00</span>
                  </div>
                </div>

                <div class="help-actions">
                  <button class="primary-btn" type="button" (click)="openNewDemandeModal()">
                    Nouvelle demande de panne
                  </button>

                  <button class="secondary-btn" type="button" (click)="setActive('mes-demandes')">
                    Voir mes demandes
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- ========== MODAL "NOUVELLE DEMANDE" ========== -->
      <div class="modal-backdrop" *ngIf="showNewDemandeModal">
        <div class="modal">
          <div class="modal-header">
            <h2>Nouvelle demande de panne</h2>
            <button class="icon-btn" (click)="closeNewDemandeModal()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body">
            <div class="form-grid">

              <div class="form-field">
                <label for="titre">Titre de la demande<span class="required">*</span></label>
                <input
                  id="titre"
                  type="text"
                  name="titre"
                  [(ngModel)]="newDemande.titre"
                  placeholder="Ex : PC en panne"
                />
              </div>

              <div class="form-field">
                <label for="lieu">Lieu<span class="required">*</span></label>
                <input
                  id="lieu"
                  type="text"
                  name="lieu"
                  [(ngModel)]="newDemande.lieu"
                  placeholder="Ex : PGF-SUP salle 10"
                />
              </div>

              <!-- Type d'√©quipement (preset) -->
              <div class="form-field">
                <label for="equipementPreset">Type d‚Äô√©quipement<span class="required">*</span></label>

                <select
                  id="equipementPreset"
                  name="equipementPreset"
                  [(ngModel)]="selectedEquipementPreset"
                  (ngModelChange)="selectedEquipementPreset = $event; equipementAutre = ($event === 'AUTRE') ? equipementAutre : ''"
                >

                <option value="" disabled>Choisissez un √©quipement‚Ä¶</option>

                  <option *ngFor="let name of equipementsPreset" [value]="name">
                    {{ name === 'AUTRE' ? 'Autre (√©quipement non list√©)' : name }}
                  </option>
                </select>
              </div>

              <!-- Champ "Autre" si n√©cessaire -->
              <div class="form-field" *ngIf="isAutreEquipement()">
                <label for="equipementAutre">Pr√©cisez l‚Äô√©quipement<span class="required">*</span></label>
                <input
                  id="equipementAutre"
                  type="text"
                  name="equipementAutre"
                  [(ngModel)]="equipementAutre"
                  placeholder="Ex : Lampe"
                />
              </div>


              <!-- Urgence du demandeur -->
              <div class="form-field">
                <label for="urgenceDemandeur">Urgence (votre estimation)<span class="required">*</span></label>
                <select
                  id="urgenceDemandeur"
                  name="urgenceDemandeur"
                  [(ngModel)]="newDemande.urgenceDemandeur"
                >
                  <option [ngValue]="null" disabled>Choisissez une urgence‚Ä¶</option>
                  <option [ngValue]="'BASSE'">Basse</option>
                  <option [ngValue]="'MOYENNE'">Moyenne</option>
                  <option [ngValue]="'HAUTE'">Haute</option>
                </select>
              </div>

              <div class="form-field">
                <label for="image">
                  Image de l‚Äô√©quipement <span class="required">*</span>
                </label>
                <input
                  id="image"
                  type="file"
                  accept="image/*"
                  (change)="onFileSelected($event)"
                />

                <p class="error-text" *ngIf="imageErrorMessage">
                  {{ imageErrorMessage }}
                </p>


                <!-- Aper√ßu + bouton suppression -->
                <div
                  class="image-preview-wrapper"
                  *ngIf="newDemande.imagePreview"
                >
                  <img
                    [src]="newDemande.imagePreview"
                    alt="Aper√ßu de l'image"
                    class="image-preview"
                  />
                  <button
                    type="button"
                    class="remove-img-btn"
                    (click)="removeSelectedImage()"
                    aria-label="Retirer l'image"
                  >
                    ‚úï
                  </button>
                </div>
              </div>

              <div class="form-field form-full">
                <label for="description">Description de la panne</label>
                <textarea
                  id="description"
                  rows="4"
                  name="description"
                  [(ngModel)]="newDemande.description"
                  placeholder="D√©crivez la panne : sympt√¥mes, contexte, fr√©quence, impact sur vos activit√©s‚Ä¶"
                ></textarea>
              </div>

            </div>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" (click)="closeNewDemandeModal()">
              Annuler
            </button>
            <button
              class="primary-btn"
              (click)="submitNewDemande()"
              [disabled]="!isNewDemandeValid()"
            >
              Enregistrer la demande
            </button>

          </div>
        </div>
      </div>

      <!-- ========== MODAL "D√âTAILS DEMANDE" ========== -->
      <div class="modal-backdrop" *ngIf="showDetailsModal && selectedDemande">
        <div class="modal">
          <div class="modal-header">
            <h2>D√©tails de la demande</h2>
            <button class="icon-btn" (click)="closeDetailsModal()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body details-body">
            <h3 class="details-title">
              {{ selectedDemande.titre }}
            </h3>
            <p class="details-meta">
              Cr√©√©e le {{ selectedDemande.dateCreation | date:'yyyy-MM-dd' }}
              ¬∑ {{ selectedDemande.lieu }}
            </p>

            <div class="details-grid">
              <div class="details-item">
                <span class="details-label">Type d‚Äô√©quipement</span>
                <span class="details-value">
                  {{ selectedDemande.typeEquipement }}
                </span>
              </div>

              <!-- Urgence demandeur -->
              <div class="details-item">
                <span class="details-label">Urgence (demandeur)</span>
                <span class="details-value">
                  <span
                    class="urgence-chip"
                    [ngClass]="getUrgenceChipClass(selectedDemande?.urgenceDemandeur)"
                    *ngIf="selectedDemande?.urgenceDemandeur"
                  >
                    {{ getUrgenceLabel(selectedDemande?.urgenceDemandeur) }}
                  </span>
                </span>
              </div>

              <div class="details-item">
                <span class="details-label">Statut</span>
                <span
                  class="status-chip"
                  [ngClass]="{
                    'pending': selectedDemande.statut === 'EN_ATTENTE',
                    'progress': selectedDemande.statut === 'EN_COURS',
                    'done': selectedDemande.statut === 'RESOLUE'
                  }"
                >
                  {{ getStatutLabel(selectedDemande.statut) }}
                </span>
              </div>

              <div class="details-item details-full">
                <span class="details-label">Description</span>
                <p class="details-description">
                  {{ selectedDemande.description }}
                </p>
              </div>

              <div class="details-item details-full">
                <span class="details-label">Image jointe</span>

                <ng-container *ngIf="selectedDemande.imageUrl; else noImage">
                  <button
                    class="secondary-btn small"
                    type="button"
                    (click)="showImageInDetails = !showImageInDetails"
                  >
                    {{
                      showImageInDetails
                        ? "Masquer l'image"
                        : "Afficher l'image"
                    }}
                  </button>

                  <div
                    class="details-image-wrapper"
                    *ngIf="showImageInDetails"
                  >
                    <img
                      [src]="selectedDemande.imageUrl"
                      alt="Image de la demande"
                      class="details-image"
                    />
                  </div>
                </ng-container>

                <ng-template #noImage>
                  <span class="details-value">
                    Aucune image jointe
                  </span>
                </ng-template>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" (click)="closeDetailsModal()">
              Fermer
            </button>

            <button
              class="primary-btn relance-modal-btn"
              (click)="relancerSelectedDemande()"
              [disabled]="!selectedDemande || !peutRelancer(selectedDemande)"
            >
              Relancer cette demande
            </button>
          </div>
        </div>
      </div>

    </div>

    <!-- ========== TOAST SUCC√àS ========== -->
    <div class="toast" *ngIf="showSuccessToast">
      <span class="toast-icon material-icons">check_circle</span>
      <span>{{ successMessage }}</span>
    </div>

  </main>
</div>
