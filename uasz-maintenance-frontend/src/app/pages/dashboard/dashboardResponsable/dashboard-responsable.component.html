<!-- src/app/pages/dashboard/dashboardResponsable/dashboard-responsable.component.html -->

<div class="dashboard-layout">
  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="avatar-circle">{{ usernameInitial }}</div>
      <div class="sidebar-title">
        <h1>Maintenance UASZ</h1>
        <p>Parc &amp; interventions</p>
      </div>
    </div>

    <nav class="sidebar-nav">
      <!-- Tableau de bord (demandes) -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'dashboard'"
        (click)="setActive('dashboard')"
      >
        <span class="nav-icon material-icons">dashboard</span>
        <span class="nav-label">Tableau de bord</span>
      </button>

      <!-- Techniciens -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'techniciens'"
        (click)="setActive('techniciens')"
      >
        <span class="nav-icon material-icons">group</span>
        <span class="nav-label">Techniciens</span>
      </button>

      <!-- üîπ Mes demandes (ajout√© ici) -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'mes-demandes'"
        (click)="setActive('mes-demandes')"
      >
        <span class="nav-icon material-icons">assignment</span>
        <span class="nav-label">Mes demandes</span>
      </button>

      <!-- Gestion stock -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'equipements'"
        (click)="setActive('equipements')"
      >
        <span class="nav-icon material-icons">inventory_2</span>
        <span class="nav-label">Gestion stock</span>
      </button>

      <!-- Maintenance pr√©ventive -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'preventives'"
        (click)="setActive('preventives')"
      >
        <span class="nav-icon material-icons">event</span>
        <span class="nav-label">Maintenance pr√©ventive</span>
      </button>

      <!-- Rapports & stats -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'rapports'"
        (click)="setActive('rapports')"
      >
        <span class="nav-icon material-icons">bar_chart</span>
        <span class="nav-label">Rapports &amp; stats</span>
      </button>

      <!-- Aide & support -->
      <button
        class="nav-item"
        [class.active]="activeItem === 'help'"
        (click)="setActive('help')"
      >
        <span class="nav-icon material-icons">help_outline</span>
        <span class="nav-label">Aide &amp; support</span>
      </button>
    </nav>
  </aside>

  <!-- ===== MAIN ===== -->
  <main class="main">
    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-left">
        <h2>Tableau de bord ¬∑ Responsable</h2>
        <p>Vue globale des demandes et interventions de maintenance.</p>
      </div>

      <div class="topbar-right">
        <!-- Bouton ic√¥ne (3 lignes) -->
        <button
          type="button"
          class="user-menu-toggle"
          (click)="toggleUserMenu($event)"
          aria-label="Ouvrir le menu utilisateur"
        >
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>

        <!-- Menu utilisateur -->
        <div
          class="user-menu"
          *ngIf="userMenuOpen"
          (click)="$event.stopPropagation()"
        >
          <div class="user-menu-header">
            <div class="menu-avatar">{{ usernameInitial }}</div>
            <div>
              <div class="menu-name">{{ username }}</div>
              <div class="menu-role">responsable</div>
            </div>
          </div>

          <div class="user-menu-body">
            <button class="menu-item" (click)="goToDashboard()">
              <span class="menu-icon material-icons">space_dashboard</span>
              <span>Tableau de bord</span>
            </button>

            <button class="menu-item" (click)="goToProfile()">
              <span class="menu-icon material-icons">person</span>
              <span>Mon profil</span>
            </button>

          </div>

          <div class="user-menu-footer">
            <!-- Ouvre la modale de confirmation -->
            <button class="menu-item logout" (click)="openLogoutConfirm()">
              <span class="menu-icon material-icons">logout</span>
              <span>Se d√©connecter</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- ===== CONTENU ===== -->
    <section class="content">
      <!-- üü¶ PAGE : DASHBOARD / DEMANDES -->
      <ng-container *ngIf="activeItem === 'dashboard'">
        <!-- Carte de bienvenue -->
        <section class="welcome-card">
          <h1>Bienvenue, {{ username.toLowerCase() }}</h1>
          <p>
            Voici la vue d‚Äôensemble des demandes de maintenance de l‚ÄôUASZ :
            priorit√©s, techniciens et avancement global.
          </p>
        </section>

        <!-- Section Demandes -->
        <section class="resp-demandes-page">
          <div class="resp-page-header">
            <div>
              <h1>
                <span class="material-icons resp-header-icon">assignment</span>
                Demandes de maintenance
              </h1>
              <p>
                Consultation, priorisation et affectation des signalements
                entrants.
              </p>
            </div>
          </div>

          <!-- Filtres -->
          <div class="resp-filters-card">
            <!-- Filtres par statut -->
            <div class="resp-status-filters">
              <button
                class="resp-status-chip"
                [class.active]="statusFilter === 'TOUTES'"
                (click)="onStatusFilterChange('TOUTES')"
              >
                <span class="resp-chip-dot all"></span>
                <span>Toutes ({{ totalDemandes }})</span>
              </button>

              <button
                class="resp-status-chip"
                [class.active]="statusFilter === 'EN_ATTENTE'"
                (click)="onStatusFilterChange('EN_ATTENTE')"
              >
                <span class="resp-chip-dot pending"></span>
                <span>En attente ({{ getStatusCount('EN_ATTENTE') }})</span>
              </button>

              <button
                class="resp-status-chip"
                [class.active]="statusFilter === 'EN_COURS'"
                (click)="onStatusFilterChange('EN_COURS')"
              >
                <span class="resp-chip-dot in-progress"></span>
                <span>En cours ({{ getStatusCount('EN_COURS') }})</span>
              </button>

              <button
                class="resp-status-chip"
                [class.active]="statusFilter === 'RESOLUE'"
                (click)="onStatusFilterChange('RESOLUE')"
              >
                <span class="resp-chip-dot resolved"></span>
                <span>R√©solues ({{ getStatusCount('RESOLUE') }})</span>
              </button>
            </div>

            <!-- Ligne Urgence + Recherche -->
            <div class="resp-urgence-row">
              <div class="resp-urgence-filter">
                <span class="resp-urgence-label">Urgence :</span>

                <button
                  class="resp-urgence-chip"
                  [class.active]="urgenceFilter === 'TOUTES'"
                  (click)="onUrgenceFilterChange('TOUTES')"
                >
                  Toutes
                </button>

                <button
                  class="resp-urgence-chip"
                  [class.active]="urgenceFilter === 'BASSE'"
                  (click)="onUrgenceFilterChange('BASSE')"
                >
                  Basse
                </button>

                <button
                  class="resp-urgence-chip"
                  [class.active]="urgenceFilter === 'MOYENNE'"
                  (click)="onUrgenceFilterChange('MOYENNE')"
                >
                  Moyenne
                </button>

                <button
                  class="resp-urgence-chip"
                  [class.active]="urgenceFilter === 'HAUTE'"
                  (click)="onUrgenceFilterChange('HAUTE')"
                >
                  Haute
                </button>
              </div>

              <div class="resp-search-box">
                <span class="material-icons resp-search-icon">search</span>
                <input
                  type="text"
                  placeholder="Rechercher par titre, demandeur, statut..."
                  (input)="onSearchTermChange($event.target.value)"
                />
              </div>
            </div>
          </div>

          <!-- Tableau des demandes -->
          <section class="resp-table-card">
            <div class="resp-table-header">
              <div>
                <h2>Signalements</h2>
                <p>
                  Vue synth√©tique des demandes en fonction de leur statut et de
                  leur niveau d‚Äôurgence.
                </p>
              </div>
            </div>

            <div class="resp-table-wrapper">
              <table class="resp-demandes-table">
                <thead>
                <tr>
                  <th>Titre</th>
                  <th>Statut</th>
                  <th>Urgence</th>
                  <th class="resp-actions-col">Actions</th>
                </tr>
                </thead>

                <tbody>
                <tr *ngFor="let d of paginatedDemandes">
                  <td class="resp-title-cell">
                    <div class="resp-title-main">{{ d.titre }}</div>
                    <div class="resp-title-sub">
                      {{ d.demandeurNom }}
                    </div>
                  </td>

                  <td>
                      <span
                        class="status-chip"
                        [ngClass]="{
                          pending: d.statut === 'EN_ATTENTE',
                          progress: d.statut === 'EN_COURS',
                          done: d.statut === 'RESOLUE'
                        }"
                      >
                        {{
                          d.statut === 'EN_ATTENTE'
                            ? 'En attente'
                            : d.statut === 'EN_COURS'
                              ? 'En cours'
                              : 'R√©solue'
                        }}
                      </span>
                  </td>

                  <td class="urgency-cell">
  <span
    class="urgency-pill"
    [ngClass]="getUrgenceListClass(d.urgenceDemandeur)"
  >
    {{ getUrgenceLabel(d.urgenceDemandeur) }}
  </span>
                  </td>



                  <td class="resp-actions-col">
                    <button
                      type="button"
                      class="resp-btn-ghost"
                      (click)="openDemandeDetails(d)"
                    >
                      <span class="material-icons">visibility</span>
                      <span>Voir d√©tails</span>
                    </button>
                  </td>
                </tr>

                <tr *ngIf="paginatedDemandes.length === 0">
                  <td colspan="4" class="resp-no-data">
                    <div class="resp-no-data-icon">
                      <span class="material-icons">inbox</span>
                    </div>
                    <div>Aucune demande ne correspond aux filtres.</div>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div
              class="resp-pagination"
              *ngIf="filteredDemandes.length > pageSize"
            >
              <div>
                Affichage
                {{ pageStartIndex }}‚Äì{{ pageEndIndex }} sur
                {{ filteredDemandes.length }} demandes
              </div>

              <div class="resp-pagination-buttons">
                <button
                  class="resp-page-btn"
                  (click)="previousPage()"
                  [disabled]="currentPage === 1"
                >
                  Pr√©c√©dent
                </button>

                <button
                  class="resp-page-btn"
                  *ngFor="let page of totalPagesArray"
                  [class.active]="page === currentPage"
                  (click)="goToPage(page)"
                >
                  {{ page }}
                </button>

                <button
                  class="resp-page-btn"
                  (click)="nextPage()"
                  [disabled]="currentPage === totalPages"
                >
                  Suivant
                </button>
              </div>
            </div>
          </section>
        </section>
      </ng-container>

      <!-- üü¶ PAGE : TECHNICIENS -->
      <ng-container *ngIf="activeItem === 'techniciens'">
        <section class="resp-tech-page">
          <div class="resp-page-header">
            <div>
              <h1>
                <span class="material-icons resp-header-icon">group</span>
                √âquipe technique
              </h1>
              <p>
                Vue d‚Äôensemble des techniciens, de leurs domaines et de leur
                charge actuelle.
              </p>
            </div>
          </div>

          <!-- Filtres techniciens -->
          <div class="resp-tech-filters-card">
            <div class="resp-tech-search-box">
              <span class="material-icons resp-search-icon">search</span>
              <input
                type="text"
                placeholder="Rechercher par nom, pr√©nom, cat√©gorie..."
                (input)="onTechnicienSearchChange($event.target.value)"
              />
            </div>

            <div class="resp-tech-filter-row">
              <select
                class="resp-tech-filter-select"
                [(ngModel)]="technicienDisponibiliteFilter"
                (change)="onTechnicienFiltersChanged()"
              >
                <option value="TOUS">Toutes les disponibilit√©s</option>
                <option value="DISPONIBLE">Disponibles</option>
                <option value="OCCUPE">Occup√©s</option>
              </select>

              <select
                class="resp-tech-filter-select"
                [(ngModel)]="technicienCategorieFilter"
                (change)="onTechnicienFiltersChanged()"
              >
                <option value="TOUTES">Toutes les cat√©gories</option>
                <option *ngFor="let c of technicienCategories" [ngValue]="c">
                  {{ c }}
                </option>
              </select>
            </div>
          </div>

          <!-- Liste techniciens -->
          <section class="resp-tech-list">
            <article
              class="resp-tech-card"
              *ngFor="let t of filteredTechniciens"
              (click)="openTechnicienDetails(t)"
            >
              <div class="resp-tech-header">
                <div>
                  <h3>{{ t.nom }}</h3>

                  <p class="resp-tech-specialites">
                    {{ t.categorie }}
                    <ng-container *ngIf="t.sousCategorie">
                      ¬∑ {{ t.sousCategorie }}
                    </ng-container>
                  </p>
                </div>

                <span
                  class="resp-tech-badge"
                  [ngClass]="{
          dispo: t.disponible,
          'non-dispo': !t.disponible
        }"
                >
        <span class="resp-tech-dot"></span>
                  {{ t.disponible ? 'Disponible' : 'Occup√©' }}
      </span>
              </div>

              <div class="details-meta" *ngIf="loadingTechStats">
                Chargement des statistiques...
              </div>

              <div class="details-meta" *ngIf="errorTechStats" style="color:#b91c1c;">
                {{ errorTechStats }}
              </div>

              <div class="resp-tech-stats-row" *ngIf="t.stats as s">
                <div class="resp-tech-stat">
                  <div class="label">En cours</div>
                  <div class="value">{{ s.enCours }}</div>
                </div>

                <div class="resp-tech-stat">
                  <div class="label">Termin√©es</div>
                  <div class="value">{{ s.terminees }}</div>
                </div>

                <div class="resp-tech-stat">
                  <div class="label">Temps moyen</div>
                  <div class="value">{{ s.tempsMoyenHeures }}</div>
                </div>
              </div>
            </article>
          </section>

        </section>
      </ng-container>

      <!-- ========== SECTION MES DEMANDES (RESPONSABLE COMME DEMANDEUR) ========== -->
      <section *ngIf="activeItem === 'mes-demandes'">
        <div class="recent-requests">

          <!-- En-t√™te : titre + bouton -->
          <div class="recent-header">
            <h2>Toutes mes demandes</h2>

            <button class="primary-btn" (click)="ouvrirNouvelleDemande()">
              Nouvelle demande de panne
            </button>
          </div>

          <!-- üîç Filtres statut / urgence / recherche (IDENTIQUE DEMANDEUR) -->
          <div class="filters-card">

            <!-- Ligne statuts -->
            <div class="filters-row status-row">
              <button
                class="filter-chip"
                [class.active]="filtreStatut === 'TOUS'"
                (click)="changerFiltreStatut('TOUS')"
              >
                <span class="status-dot dot-all"></span>
                <span>Toutes ({{ mesDemandes.length }})</span>
              </button>

              <button
                class="filter-chip"
                [class.active]="filtreStatut === 'EN_ATTENTE'"
                (click)="changerFiltreStatut('EN_ATTENTE')"
              >
                <span class="status-dot dot-pending"></span>
                <span>En attente ({{ countMesParStatut('EN_ATTENTE') }})</span>
              </button>

              <button
                class="filter-chip"
                [class.active]="filtreStatut === 'EN_COURS'"
                (click)="changerFiltreStatut('EN_COURS')"
              >
                <span class="status-dot dot-progress"></span>
                <span>En cours ({{ countMesParStatut('EN_COURS') }})</span>
              </button>

              <button
                class="filter-chip"
                [class.active]="filtreStatut === 'RESOLUE'"
                (click)="changerFiltreStatut('RESOLUE')"
              >
                <span class="status-dot dot-done"></span>
                <span>R√©solues ({{ countMesParStatut('RESOLUE') }})</span>
              </button>
            </div>

            <!-- Ligne urgences + recherche -->
            <div class="filters-row urgency-row">
              <div class="urg-left">
                <span class="urg-label">Urgence :</span>

                <div class="urg-chips">
                  <button
                    class="filter-chip"
                    [class.active]="filtreUrgence === 'TOUTES'"
                    (click)="changerFiltreUrgence('TOUTES')"
                  >
                    Toutes
                  </button>

                  <button
                    class="filter-chip"
                    [class.active]="filtreUrgence === 'BASSE'"
                    (click)="changerFiltreUrgence('BASSE')"
                  >
                    Basse
                  </button>

                  <button
                    class="filter-chip"
                    [class.active]="filtreUrgence === 'MOYENNE'"
                    (click)="changerFiltreUrgence('MOYENNE')"
                  >
                    Moyenne
                  </button>

                  <button
                    class="filter-chip"
                    [class.active]="filtreUrgence === 'HAUTE'"
                    (click)="changerFiltreUrgence('HAUTE')"
                  >
                    Haute
                  </button>
                </div>
              </div>

              <div class="filters-search">
                <div class="search-wrapper">
                  <span class="material-icons search-icon">search</span>
                  <input
                    type="text"
                    placeholder="Rechercher par titre, lieu, statut..."
                    [(ngModel)]="mesSearchTerm"
                    (ngModelChange)="onMesSearchChange($event)"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Liste des demandes du responsable -->
          <div class="requests-list" *ngIf="mesDemandesPaged?.length; else aucuneDemandeResp">
            <div
              *ngFor="let demande of mesDemandesPaged"
              class="request-item request-clickable"
              (click)="ouvrirDetailDemande(demande)"
            >
              <div>
                <h3 class="request-title">{{ demande.titre }}</h3>
                <p class="request-meta">
                  Cr√©√©e le {{ demande.dateCreation | date:'yyyy-MM-dd' }} ¬∑ {{ demande.lieu }}
                </p>
              </div>

              <div class="request-right">
          <span
            class="status-chip"
            [ngClass]="{
              pending: demande.statut === 'EN_ATTENTE',
              progress: demande.statut === 'EN_COURS',
              done: demande.statut === 'RESOLUE'
            }"
          >
            {{ libelleStatut(demande.statut) }}
          </span>
              </div>
            </div>
          </div>

          <!-- √âtat vide -->
          <ng-template #aucuneDemandeResp>
            <div class="empty-state">
              <p>Vous n'avez encore cr√©√© aucune demande de maintenance.</p>
              <button class="secondary-btn small" (click)="ouvrirNouvelleDemande()">
                Cr√©er une premi√®re demande
              </button>
            </div>
          </ng-template>

          <!-- üî¢ Pagination (IDENTIQUE DEMANDEUR) -->
          <div class="pagination-bar" *ngIf="(mesDemandesFiltrees?.length || 0) > mesPageSize">
            <div class="pagination-info">
              Page {{ mesCurrentPage }} sur {{ mesTotalPages }}
            </div>

            <div class="pagination-actions">
              <button
                class="secondary-btn small pagination-btn"
                (click)="mesGoToPreviousPage()"
                [disabled]="mesCurrentPage === 1"
              >
                Pr√©c√©dent
              </button>

              <button
                class="secondary-btn small pagination-btn"
                (click)="mesGoToNextPage()"
                [disabled]="mesCurrentPage === mesTotalPages"
              >
                Suivant
              </button>
            </div>
          </div>

        </div>

        <!-- ========== MODAL "NOUVELLE DEMANDE" (RESPONSABLE) ========== -->
        <div class="modal-backdrop" *ngIf="showMesNewDemandeModal">
          <div class="modal">
            <div class="modal-header">
              <h2>Nouvelle demande de panne</h2>
              <button class="icon-btn" (click)="closeMesNewDemandeModal()">
                <span class="material-icons">close</span>
              </button>
            </div>

            <div class="modal-body">
              <div class="form-grid">
                <!-- Titre (obligatoire) -->
                <div class="form-field">
                  <label for="titre-resp">Titre de la demande <span class="req">*</span></label>
                  <input
                    id="titre-resp"
                    type="text"
                    name="titre-resp"
                    [(ngModel)]="newMesDemande.titre"
                    (ngModelChange)="onMesFormChange()"
                    placeholder="Ex : PC en panne"
                  />
                </div>

                <!-- Lieu (obligatoire) -->
                <div class="form-field">
                  <label for="lieu-resp">Lieu <span class="req">*</span></label>
                  <input
                    id="lieu-resp"
                    type="text"
                    name="lieu-resp"
                    [(ngModel)]="newMesDemande.lieu"
                    (ngModelChange)="onMesFormChange()"
                    placeholder="Ex : PGF-SUP salle 10"
                  />
                </div>

                <!-- Type d‚Äô√©quipement (obligatoire) : SELECT + AUTRE -->
                <div class="form-field">
                  <label for="typeEquipement-resp">Type d‚Äô√©quipement <span class="req">*</span></label>

                  <select
                    id="typeEquipement-resp"
                    name="typeEquipement-resp"
                    class="form-control"
                    [(ngModel)]="newMesDemande.typeEquipement"
                    (ngModelChange)="onMesEquipementChange($event)"
                  >
                    <option value="" disabled>Choisissez un √©quipement...</option>

                    <option *ngFor="let e of equipementTypesUniversite" [value]="e">
                      {{ e }}
                    </option>

                    <option value="Autre">Autre</option>
                  </select>
                </div>

                <!-- Champ texte si Autre -->
                <div class="form-field" *ngIf="newMesDemande.typeEquipement === 'Autre'">
                  <label for="typeEquipementAutre-resp">Pr√©cisez l‚Äô√©quipement <span class="req">*</span></label>
                  <input
                    id="typeEquipementAutre-resp"
                    type="text"
                    name="typeEquipementAutre-resp"
                    class="form-control"
                    [(ngModel)]="newMesDemande.typeEquipementAutre"
                  />
                </div>


                <!-- Urgence (obligatoire) -->
                <div class="form-field">
                  <label for="urgence-resp">Urgence (votre estimation) <span class="req">*</span></label>

                  <select
                    id="urgence-resp"
                    name="urgence-resp"
                    class="form-control"
                    [(ngModel)]="newMesDemande.urgence"
                  >
                    <option value="" disabled>Choisissez une urgence...</option>
                    <option value="BASSE">Basse</option>
                    <option value="MOYENNE">Moyenne</option>
                    <option value="HAUTE">Haute</option>
                  </select>
                </div>


                <!-- Image (obligatoire) -->
                <div class="form-field">
                  <label for="image-resp">Image de l‚Äô√©quipement <span class="req">*</span></label>

                  <input
                    id="image-resp"
                    type="file"
                    accept="image/*"
                    (change)="onMesFileSelected($event)"
                  />

                  <!-- ‚úÖ message rouge si erreur -->
                  <p class="field-error" *ngIf="mesImageError">
                    {{ mesImageError }}
                  </p>

                  <div class="image-preview-wrapper" *ngIf="newMesDemande.imagePreview">
                    <img [src]="newMesDemande.imagePreview" class="image-preview" />
                    <button type="button" class="remove-img-btn" (click)="removeMesSelectedImage()">‚úï</button>
                  </div>
                </div>


                <!-- Description (optionnelle) -->
                <div class="form-field form-full">
                  <label for="description-resp">Description de la panne</label>
                  <textarea
                    id="description-resp"
                    rows="4"
                    name="description-resp"
                    [(ngModel)]="newMesDemande.description"
                    placeholder="D√©crivez la panne : sympt√¥mes, contexte, fr√©quence, impact sur vos activit√©s‚Ä¶"
                  ></textarea>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button class="secondary-btn small pagination-btn" (click)="closeMesNewDemandeModal()">
                Annuler
              </button>

              <!-- ‚úÖ D√©sactiv√© tant que champs obligatoires pas OK (Description ignor√©e) -->
              <button
                class="primary-btn"
                (click)="submitMesNewDemande()"
                [disabled]="!isMesNewDemandeValid() || !!mesImageError || loadingMesCreate"
              >
                {{ loadingMesCreate ? 'Enregistrement...' : 'Enregistrer la demande' }}
              </button>
            </div>
          </div>
        </div>

        <!-- ========== MODAL "D√âTAILS DE LA DEMANDE" (RESPONSABLE) ========== -->
        <div
          class="modal-backdrop"
          *ngIf="showMesDetailsModal && selectedMesDemande"
        >
          <div class="modal">
            <div class="modal-header">
              <h2>D√©tails de la demande</h2>
              <button class="icon-btn" (click)="closeMesDetailsModal()">
                <span class="material-icons">close</span>
              </button>
            </div>

            <div class="modal-body details-body">
              <h3 class="details-title">
                {{ selectedMesDemande?.titre }}
              </h3>

              <p class="details-meta">
                Cr√©√©e le {{ selectedMesDemande?.dateCreation | date:'yyyy-MM-dd' }}
                ¬∑ {{ selectedMesDemande?.lieu }}
              </p>

              <div class="details-grid">
                <!-- Type √©quipement -->
                <div class="details-item">
                  <span class="details-label">Type d‚Äô√©quipement</span>
                  <span class="details-value">
            {{ selectedMesDemande?.typeEquipement }}
          </span>
                </div>

                <!-- Urgence (demandeur) -->
                <div class="field">
                  <div class="field-label">Urgence</div>

                  <div class="urgency-pill" [ngClass]="getUrgenceListClassAny(selectedMesDemande?.urgence)">
                    {{ libelleUrgence(selectedMesDemande?.urgence) }}
                  </div>
                </div>



                <!-- Statut -->
                <div class="details-item details-full">
                  <span class="details-label">Statut</span>

                  <span
                    class="status-pill"
                    [ngClass]="badgeClass(selectedMesDemande?.statut)"
                  >
            {{ libelleStatut(selectedMesDemande?.statut) }}
          </span>
                </div>

                <!-- Description -->
                <div class="details-item details-full">
                  <span class="details-label">Description</span>

                  <p class="details-description" *ngIf="selectedMesDemande?.description; else noDesc">
                    {{ selectedMesDemande?.description }}
                  </p>

                  <ng-template #noDesc>
                    <span class="details-muted">Aucune description</span>
                  </ng-template>
                </div>

                <!-- Image jointe -->
                <div class="details-item details-full">
                  <span class="details-label">Image jointe</span>

                  <ng-container *ngIf="selectedMesDemande?.imageUrl; else noMesImage">
                    <button
                      type="button"
                      class="secondary-btn small pagination-btn"
                      (click)="toggleMesImageDetails()"
                    >
                      {{ showMesImageInDetails ? "Masquer l'image" : "Afficher l'image" }}
                    </button>

                    <div class="details-image-wrapper" *ngIf="showMesImageInDetails">
                      <img
                        [src]="selectedMesDemande?.imageUrl"
                        alt="Image de la demande"
                        class="details-image"
                      />
                    </div>
                  </ng-container>

                  <ng-template #noMesImage>
                    <span class="details-muted">Aucune image jointe</span>
                  </ng-template>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button class="secondary-btn small pagination-btn" (click)="closeMesDetailsModal()">
                Fermer
              </button>
            </div>
          </div>
        </div>


      </section>



      <!-- üü¶ PAGE : GESTION STOCK -->
      <ng-container *ngIf="activeItem === 'equipements'">
        <section class="resp-equipements-page">
          <div class="resp-page-header">
            <div>
              <h1>
                <span class="material-icons resp-header-icon">inventory_2</span>
                Gestion stock
              </h1>
              <p>
                Gestion du stock des principaux √©quipements : quantit√©s
                disponibles, ajout, modification et suppression.
              </p>
            </div>
          </div>

          <!-- Filtres √©quipements + bouton Ajouter -->
          <div class="equip-filters-card">
            <div class="equip-filters-left">
              <div class="resp-tech-search-box">
                <span class="material-icons resp-search-icon">search</span>
                <input
                  type="text"
                  placeholder="Rechercher par r√©f√©rence, type..."
                  (input)="onEquipementSearchChange($event.target.value)"
                />
              </div>
            </div>

            <div class="equip-filters-right">
              <select
                class="resp-tech-filter-select"
                [(ngModel)]="equipementEtatFilter"
              >
                <option value="TOUS">Tous les √©tats</option>
                <option value="EN_SERVICE">En service</option>
                <option value="EN_PANNE">En panne</option>
                <option value="HORS_SERVICE">Hors service</option>
              </select>

              <select
                class="resp-tech-filter-select"
                [(ngModel)]="equipementTypeFilter"
              >
                <option value="TOUS">Tous les types</option>
                <option *ngFor="let t of equipementTypes" [ngValue]="t">
                  {{ t }}
                </option>
              </select>

              <button
                type="button"
                class="resp-btn-outline"
                (click)="openCreateStockTypeModal()"
              >
                <span class="material-icons">add</span>
                Ajouter un √©quipement
              </button>
            </div>
          </div>

          <!-- Liste des √©quipements en stock -->
          <div class="resp-reports-grid">
            <article class="report-card">
              <h3>√âquipements en stock</h3>
              <p class="report-subtitle">
                Liste des √©quipements en stock avec leur quantit√© disponible.
              </p>

              <div class="resp-table-wrapper">
                <table class="resp-demandes-table">
                  <thead>
                  <tr>
                    <th>Type</th>
                    <th>Quantit√©</th>
                    <th class="resp-actions-col">Actions</th>
                  </tr>
                  </thead>

                  <tbody>
                  <tr *ngFor="let e of filteredEquipementsStock">
                    <td>{{ e.type }}</td>
                    <td>{{ e.total }}</td>
                    <td class="resp-actions-col">
                      <button type="button" class="resp-btn-ghost" (click)="openStockDetails(e.typeId)">
                        <span class="material-icons">visibility</span>
                        <span>Voir d√©tails</span>
                      </button>
                    </td>
                  </tr>

                  <tr *ngIf="filteredEquipementsStock.length === 0">
                    <td colspan="3" class="resp-no-data">
                      <div class="resp-no-data-icon">
                        <span class="material-icons">inventory_2</span>
                      </div>
                      <div>Aucun √©quipement ne correspond √† la recherche.</div>
                    </td>
                  </tr>
                  </tbody>
                </table>

              </div>
            </article>
          </div>
        </section>
      </ng-container>

      <!-- ========================= -->
      <!-- ‚úÖ MODALE AJOUT √âQUIPEMENT -->
      <!-- ========================= -->
      <!-- ===== MODAL AJOUT TYPE EQUIPEMENT (STOCK) ===== -->
      <div class="modal-backdrop" *ngIf="showCreateStockTypeModal">
        <div class="modal">
          <div class="modal-header">
            <h2>Ajouter un √©quipement</h2>
            <button class="icon-btn" (click)="closeCreateStockTypeModal()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body">
            <div class="details-grid" style="grid-template-columns: 1fr 1fr;">
              <!-- Type -->
              <div class="field">
                <label class="field-label">Type <span class="req">*</span></label>
                <input
                  class="field-input"
                  type="text"
                  placeholder="Ex: Imprimante"
                  [(ngModel)]="createStockForm.type"
                />
              </div>

              <!-- Quantit√© -->
              <div class="field">
                <label class="field-label">Quantit√© <span class="req">*</span></label>
                <input
                  class="field-input"
                  type="number"
                  min="1"
                  step="1"
                  [(ngModel)]="createStockForm.quantite"
                  (ngModelChange)="normalizeStockQuantity()"
                />
                <small class="field-hint">Minimum : 1</small>
              </div>

              <!-- Description -->
              <div class="field" style="grid-column: 1 / -1;">
                <label class="field-label">Description (optionnel)</label>
                <textarea
                  class="textarea-field"
                  rows="3"
                  placeholder="Infos utiles sur ce type‚Ä¶"
                  [(ngModel)]="createStockForm.description"
                ></textarea>
              </div>
            </div>

            <p class="details-meta" style="margin-top: 10px;">
              Les nouveaux √©quipements sont enregistr√©s automatiquement au <strong>magasin</strong> avec le statut
              <strong>Hors service</strong>.
            </p>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" (click)="closeCreateStockTypeModal()">
              Annuler
            </button>

            <button
              class="primary-btn"
              (click)="createStockTypeWithQuantity()"
              [disabled]="isCreateStockInvalid()"
            >
              Enregistrer
            </button>
          </div>
        </div>
      </div>


      <!-- üü¶ PAGE : MAINTENANCE PR√âVENTIVE -->
      <ng-container *ngIf="activeItem === 'preventives'">
        <section class="resp-preventives-page">
          <div class="resp-page-header">
            <div>
              <h1>
                <span class="material-icons resp-header-icon">event</span>
                Maintenance pr√©ventive
              </h1>
              <p>
                Planification des op√©rations r√©guli√®res pour √©viter les pannes.
              </p>
            </div>
          </div>

          <!-- Filtres maintenance pr√©ventive -->
          <div class="equip-filters-card">
            <div class="equip-filters-left">
              <div class="resp-tech-search-box">
                <span class="material-icons resp-search-icon">search</span>
                <input
                  type="text"
                  placeholder="Rechercher par √©quipement, description..."
                  (input)="onPreventiveSearchChange($event.target.value)"
                />
              </div>
            </div>

            <div class="equip-filters-right">
              <button
                type="button"
                class="resp-btn-outline"
                (click)="openPreventiveForm()"
              >
                <span class="material-icons">add</span>
                Nouvelle maintenance
              </button>
            </div>
          </div>

          <div class="resp-reports-grid">
            <!-- Planning d√©taill√© UNIQUEMENT -->
            <article class="report-card">
              <h3>Planning des maintenances</h3>
              <p class="report-subtitle">
                Liste des op√©rations pr√©ventives sur les √©quipements critiques.
              </p>

              <div class="resp-table-wrapper">
                <table class="resp-demandes-table">
                  <thead>
                  <tr>
                    <th>Type d‚Äô√©quipement</th>
                    <th>Fr√©quence</th>
                    <th>Prochaine date</th>
                    <th>Responsable</th>
                    <th class="resp-actions-col">Actions</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr *ngFor="let m of filteredMaintenancesPreventives">
                    <td>{{ m.typeEquipement || m.equipementReference }}</td>
                    <td>{{ m.frequence }}</td>
                    <td>{{ m.prochaineDate | date: 'yyyy-MM-dd' }}</td>
                    <td>{{ m.responsable }}</td>
                    <td class="resp-actions-col">
                      <button
                        type="button"
                        class="resp-btn-ghost"
                        (click)="openPreventiveDetails(m)"
                      >
                        <span class="material-icons">visibility</span>
                        <span>Voir d√©tails</span>
                      </button>
                    </td>
                  </tr>

                  <tr *ngIf="filteredMaintenancesPreventives.length === 0">
                    <td colspan="5" class="resp-no-data">
                      <div class="resp-no-data-icon">
                        <span class="material-icons">event_busy</span>
                      </div>
                      <div>Aucune maintenance pr√©ventive √† afficher.</div>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </article>
          </div>
        </section>
      </ng-container>

      <!-- üü¶ PAGE : RAPPORTS & STATS -->
      <ng-container *ngIf="activeItem === 'rapports'">
        <section class="resp-reports-page">
          <div class="resp-page-header">
            <div>
              <h1>
                <span class="material-icons resp-header-icon">insights</span>
                Rapports &amp; statistiques
              </h1>
              <p>
                Indicateurs synth√©tiques sur l‚Äôactivit√© de maintenance :
                volumes, statuts et temps de traitement.
              </p>
            </div>
          </div>

          <!-- Filtre p√©riode & export PDF -->
          <div class="equip-filters-card">
            <div class="equip-filters-left">
              <div class="report-period-label details-label">
                P√©riode d‚Äôanalyse
              </div>
              <div class="report-period-inputs">
                <!-- Date d√©but -->
                <input
                  type="date"
                  [(ngModel)]="rapportDateDebut"
                  [max]="rapportDateFin || today"
                  (change)="onRapportDatesChanged()"
                />
                <span class="report-period-separator">au</span>
                <!-- Date fin -->
                <input
                  type="date"
                  [(ngModel)]="rapportDateFin"
                  [min]="rapportDateDebut || ''"
                  [max]="today"
                  (change)="onRapportDatesChanged()"
                />
              </div>
            </div>

            <div class="equip-filters-right">
              <button
                type="button"
                class="resp-btn-outline"
                (click)="exportRapportPdf()"
                [disabled]="!canExportRapport"
              >
                <span class="material-icons">picture_as_pdf</span>
                Exporter le rapport
              </button>
            </div>
          </div>

          <section class="resp-reports-grid">
            <!-- Carte volume global -->
            <article class="report-card">
              <h3>Volume global</h3>
              <p class="report-subtitle">
                R√©partition des signalements selon leur avancement.
              </p>

              <div class="report-kpis">
                <div class="report-kpi">
                  <div class="label">Total</div>
                  <div class="value">{{ totalDemandes }}</div>
                </div>
                <div class="report-kpi">
                  <div class="label">En attente</div>
                  <div class="value">{{ enAttente }}</div>
                </div>
                <div class="report-kpi">
                  <div class="label">En cours</div>
                  <div class="value">{{ enCours }}</div>
                </div>
                <div class="report-kpi">
                  <div class="label">R√©solues</div>
                  <div class="value">{{ resolues }}</div>
                </div>
              </div>
            </article>

            <!-- Carte demandes par mois -->
            <article class="report-card">
              <h3>Demandes par mois</h3>
              <p class="report-subtitle">
                Activit√© mensuelle estim√©e (valeurs simul√©es).
              </p>

              <div class="report-bars">
                <div class="report-bar-row" *ngFor="let m of demandesParMois">
                  <span class="bar-label">{{ m.mois }}</span>
                  <div class="bar-track">
                    <div
                      class="bar-fill"
                      [style.width.%]="(m.total / maxDemandesParMois) * 100"
                    ></div>
                  </div>
                  <span class="bar-value">{{ m.total }}</span>
                </div>
              </div>
            </article>

            <!-- Carte r√©partition statuts -->
            <article class="report-card">
              <h3>R√©partition des statuts</h3>
              <p class="report-subtitle">
                Proportion des demandes selon leur √©tat actuel.
              </p>

              <div class="report-bars">
                <div class="report-bar-row">
                  <span class="bar-label">
                    <span class="status-dot pending"></span>
                    En attente
                  </span>
                  <div class="bar-track">
                    <div
                      class="bar-fill pending"
                      [style.width.%]="statusPercentEnAttente"
                    ></div>
                  </div>
                  <span class="bar-value">
                    {{ statusPercentEnAttente }}%
                  </span>
                </div>

                <div class="report-bar-row">
                  <span class="bar-label">
                    <span class="status-dot in-progress"></span>
                    En cours
                  </span>
                  <div class="bar-track">
                    <div
                      class="bar-fill in-progress"
                      [style.width.%]="statusPercentEnCours"
                    ></div>
                  </div>
                  <span class="bar-value">
                    {{ statusPercentEnCours }}%
                  </span>
                </div>

                <div class="report-bar-row">
                  <span class="bar-label">
                    <span class="status-dot resolved"></span>
                    R√©solues
                  </span>
                  <div class="bar-track">
                    <div
                      class="bar-fill resolved"
                      [style.width.%]="statusPercentResolues"
                    ></div>
                  </div>
                  <span class="bar-value">
                    {{ statusPercentResolues }}%
                  </span>
                </div>
              </div>
            </article>

            <!-- Carte temps moyen -->
            <article class="report-card">
              <h3>Temps moyen de r√©solution</h3>
              <p class="report-subtitle">
                Moyenne estim√©e sur les demandes cl√¥tur√©es.
              </p>

              <div class="report-time">
                <div class="time-main">
                  {{ tempsMoyenResolutionGlobal }} h
                </div>
                <div class="time-caption">
                  Sur les demandes marqu√©es comme r√©solues.
                </div>
              </div>
            </article>
          </section>
        </section>
      </ng-container>

      <!-- üü¶ PAGE : AIDE & SUPPORT -->
      <ng-container *ngIf="activeItem === 'help'">
        <section class="resp-help-page">
          <div class="recent-requests">
            <div class="recent-header">
              <h2>Aide &amp; support</h2>
              <p class="help-subtitle">
                Bonnes pratiques pour traiter les demandes et utiliser le
                tableau de bord Responsable.
              </p>
            </div>

            <div class="requests-list">
              <div class="request-item">
                <div>
                  <h3 class="request-title">
                    1. Comment prioriser les demandes ?
                  </h3>
                  <p class="request-meta">
                    <strong>√âtape 1 :</strong> ouvrez la demande via
                    <em>Voir d√©tails</em>.<br />
                    <strong>√âtape 2 :</strong> analysez la description, le lieu
                    et l‚Äôimage √©ventuelle.<br />
                    <strong>√âtape 3 :</strong> d√©finissez le niveau
                    <strong>Urgence</strong> (Basse, Moyenne, Haute).<br />
                    <strong>Conseil :</strong> traitez en priorit√© les demandes
                    <strong>Haute</strong> li√©es aux salles de cours, examens ou
                    services critiques (scolarit√©, r√©seau, datacenter).
                  </p>
                </div>
              </div>

              <div class="request-item">
                <div>
                  <h3 class="request-title">
                    2. Comment affecter un technicien efficacement ?
                  </h3>
                  <p class="request-meta">
                    Dans la fen√™tre <em>Voir d√©tails</em>, choisissez un
                    technicien dans la liste
                    <strong>Technicien affect√©</strong>.<br />
                    Tenez compte de :
                  </p>
                  <ul class="help-list">
                    <li>son domaine (bureautique, r√©seau, audiovisuel‚Ä¶)</li>
                    <li>son niveau de charge (interventions en cours)</li>
                    <li>la localisation de l‚Äô√©quipement</li>
                  </ul>
                  <p class="request-meta">
                    Une fois valid√©, le statut peut passer √†
                    <strong>En cours</strong> apr√®s prise en charge.
                  </p>
                </div>
              </div>

              <div class="request-item">
                <div>
                  <h3 class="request-title">
                    3. Quand une demande est-elle consid√©r√©e comme r√©solue ?
                  </h3>
                  <p class="request-meta">
                    Une demande est <strong>R√©solue</strong> lorsque :
                  </p>
                  <ul class="help-list">
                    <li>
                      l‚Äôintervention est termin√©e ET valid√©e avec l‚Äôutilisateur
                      (demandeur) ;
                    </li>
                    <li>
                      le mat√©riel est √† nouveau fonctionnel ou une solution
                      alternative a √©t√© mise en place ;
                    </li>
                    <li>
                      la case <em>Marquer comme r√©solue</em> est coch√©e dans la
                      fen√™tre de d√©tails.
                    </li>
                  </ul>
                  <p class="request-meta">
                    Le bouton <strong>Exporter en PDF</strong> devient alors
                    disponible pour archiver l‚Äôintervention.
                  </p>
                </div>
              </div>

              <div class="request-item">
                <div>
                  <h3 class="request-title">
                    4. Bonnes pratiques de maintenance pr√©ventive
                  </h3>
                  <p class="request-meta">
                    Utilisez l‚Äôonglet
                    <strong>Maintenance pr√©ventive</strong> pour planifier :
                  </p>
                  <ul class="help-list">
                    <li>le nettoyage et contr√¥le r√©gulier des PC et imprimantes</li>
                    <li>le remplacement planifi√© des lampes vid√©o-projecteurs</li>
                    <li>les v√©rifications r√©seau (switch, routeur, onduleurs)</li>
                  </ul>
                  <p class="request-meta">
                    Anticiper ces op√©rations r√©duit fortement le nombre de
                    pannes critiques et am√©liore la disponibilit√© du parc.
                  </p>
                </div>
              </div>

              <div class="request-item">
                <div>
                  <h3 class="request-title">
                    5. √Ä qui s‚Äôadresser en cas de probl√®me avec l‚Äôapplication ?
                  </h3>
                  <p class="request-meta">
                    Pour toute anomalie sur la plateforme (erreur d‚Äôaffichage,
                    bug, probl√®me de connexion), contactez le service
                    informatique de l‚ÄôUASZ ou l‚Äô√©quipe responsable de
                    l‚Äôapplication √† l‚Äôadresse :
                    <strong>maintenance@uasz.sn</strong><br />
                    Merci de pr√©ciser :
                  </p>
                  <ul class="help-list">
                    <li>votre profil (Responsable, Technicien‚Ä¶)</li>
                    <li>la page concern√©e (Tableau de bord, Rapports‚Ä¶)</li>
                    <li>le message d‚Äôerreur ou une capture d‚Äô√©cran</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>
      </ng-container>

      <!-- ===== MODAL D√âTAILS DEMANDE ===== -->
      <div class="modal-backdrop" *ngIf="showDetailsModal && selectedDemande">
        <div class="modal">
          <div class="modal-header">
            <h2>D√©tails de la demande</h2>
            <button class="icon-btn" (click)="closeDetailsModal()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body details-body">
            <h3 class="details-title">
              {{ selectedDemande?.titre }}
            </h3>
            <p class="details-meta">
              Cr√©√©e le
              {{ selectedDemande?.dateCreation | date: 'yyyy-MM-dd HH:mm' }}
              ¬∑ {{ selectedDemande?.lieu }} ¬∑
              <strong>{{ selectedDemande?.demandeurNom }}</strong>
            </p>

            <div class="details-grid">
              <div class="details-item">
                <span class="details-label">Type d‚Äô√©quipement</span>
                <span class="details-value">
                  {{ selectedDemande?.typeEquipement }}
                </span>
              </div>

              <div class="details-item">
                <span class="details-label">Statut</span>
                <span
                  class="resp-status-badge"
                  [ngClass]="{
                    'resp-status-en-attente':
                      selectedDemande?.statut === 'EN_ATTENTE',
                    'resp-status-en-cours':
                      selectedDemande?.statut === 'EN_COURS',
                    'resp-status-resolue':
                      selectedDemande?.statut === 'RESOLUE'
                  }"
                >
                  {{ getStatutLabel(selectedDemande!.statut) }}
                </span>
              </div>
              <div class="field">
                <div class="field-label">Urgence du demandeur</div>

                <div class="urgency-pill" [ngClass]="getUrgencePillClass(selectedDemande?.urgenceDemandeur)">
                  {{ getUrgenceLabel(selectedDemande?.urgenceDemandeur) }}
                </div>
              </div>

              <div class="field">
                <label class="field-label">Urgence (Responsable)  <span class="req">*</span></label>

                <select class="field-select" [(ngModel)]="modalUrgenceResponsable">
                  <option value="">Non d√©finie</option>
                  <option value="BASSE">Basse</option>
                  <option value="MOYENNE">Moyenne</option>
                  <option value="HAUTE">Haute</option>
                </select>
              </div>



              <div class="details-item">
                <span class="details-label">Technicien affect√©  <span class="req">*</span></span>
                <select
                  class="select-field"
                  [(ngModel)]="modalTechnicienId"
                  [disabled]="selectedDemande?.statut === 'RESOLUE'"
                >
                  <option [ngValue]="null">Choisissez un technicien</option>

                  <option *ngFor="let t of techniciens" [ngValue]="t.id">
                    {{ t.nom }}
                    <ng-container *ngIf="t.serviceUnite"> ({{ t.serviceUnite }})</ng-container>
                    <ng-container *ngIf="!t.serviceUnite && t.categorie"> ({{ t.categorie }})</ng-container>
                  </option>
                </select>
              </div>

              <div class="details-item details-full">
                <span class="details-label">Description</span>
                <p class="details-description">
                  {{ selectedDemande?.description }}
                </p>
              </div>

              <div class="details-item details-full">
                <span class="details-label">Commentaire interne</span>
                <textarea
                  class="textarea-field"
                  rows="3"
                  [(ngModel)]="modalCommentaire"
                  [disabled]="selectedDemande?.statut === 'RESOLUE'"
                  placeholder="Notes internes, diagnostic, actions r√©alis√©es, pi√®ces utilis√©es‚Ä¶"
                ></textarea>
              </div>

              <div class="details-item details-full">
                <span class="details-label">Image jointe</span>

                <ng-container
                  *ngIf="selectedDemande?.imageUrl; else noImage"
                >
                  <button
                    class="secondary-btn small pagination-btn"
                    type="button"
                    (click)="showImageInDetails = !showImageInDetails"
                  >
                    {{
                      showImageInDetails
                        ? "Masquer l'image"
                        : "Afficher l'image"
                    }}
                  </button>

                  <div
                    class="details-image-wrapper"
                    *ngIf="showImageInDetails"
                  >
                    <img
                      *ngIf="showImageInDetails && selectedDemande?.imageUrl"
                      class="details-image"
                      [src]="selectedDemande.imageUrl"
                      alt="Image panne"
                      (click)="openImageLightbox(selectedDemande.imageUrl)"
                    />

                  </div>
                </ng-container>

                <ng-template #noImage>
                  <span class="details-value details-muted">
                    Aucune image jointe
                  </span>
                </ng-template>
              </div>

              <div class="details-item details-full">
                <label class="details-label">
                  <input
                    type="checkbox"
                    [(ngModel)]="markAsResolved"
                    [disabled]="selectedDemande?.statut === 'RESOLUE'"
                  />
                  &nbsp; Marquer cette demande comme r√©solue
                </label>

                <p class="details-meta">
                  Le statut passe automatiquement √†
                  <strong>R√©solue</strong> et l‚Äôexport PDF devient disponible.
                </p>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" (click)="closeDetailsModal()">
              Fermer
            </button>

            <button
              class="resp-btn-outline"
              type="button"
              [disabled]="!canExportSelected"
              (click)="exportSelectedAsPdf()"
            >
              <span class="material-icons">picture_as_pdf</span>
              Exporter en PDF
            </button>

            <button
              class="primary-btn"
              type="button"
              [disabled]="isSaveDisabled"
              (click)="saveDetails()"
            >
              Enregistrer modifications
            </button>
          </div>
        </div>
      </div>

      <!-- ===== MODAL GESTION √âQUIPEMENT ===== -->
      <!-- ========================= -->
      <!-- MODALE : DETAILS STOCK -->
      <!-- ========================= -->
      <div class="modal-backdrop" *ngIf="showStockDetailsModal">
        <div class="modal">
          <div class="modal-header">
            <h2>D√©tails de l‚Äô√©quipement</h2>

            <button class="icon-btn" type="button" (click)="closeStockDetailsModal()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body">
            <!-- Loading -->
            <div *ngIf="loadingStockDetails" class="resp-muted">
              Chargement des d√©tails...
            </div>

            <!-- Error -->
            <div *ngIf="!loadingStockDetails && errorStockDetails" class="resp-error">
              {{ errorStockDetails }}
            </div>

            <!-- Content -->
            <ng-container *ngIf="!loadingStockDetails && !errorStockDetails && selectedStockDetails">
              <h3 class="details-title">{{ selectedStockDetails.type }}</h3>

              <div class="details-grid">
                <div class="details-item">
                  <span class="details-label">Date d‚Äôacquisition</span>
                  <span class="details-value">
      {{ selectedStockDetails?.dateAcquisition || '-' }}
    </span>
                </div>

                <div class="details-item details-full" *ngIf="selectedStockDetails?.description">
                  <span class="details-label">Description</span>
                  <p class="details-description">
                    {{ selectedStockDetails?.description }}
                  </p>
                </div>

                <div class="details-item">
                  <span class="details-label">Quantit√© totale</span>
                  <span class="details-value">{{ selectedStockDetails?.total }}</span>
                </div>

                <div class="details-item">
                  <span class="details-label">En service</span>
                  <span class="details-value">{{ selectedStockDetails?.enService }}</span>
                </div>

                <div class="details-item">
                  <span class="details-label">Hors service</span>
                  <span class="details-value">{{ selectedStockDetails?.horsService }}</span>
                </div>
              </div>


              <div style="margin-top: 12px;" *ngIf="selectedStockDetails.enServiceItems?.length">
                <div class="details-label" style="margin-bottom: 6px;">Exemplaires en service</div>

                <div class="resp-table-wrapper">
                  <table class="resp-demandes-table">
                    <thead>
                    <tr>
                      <th>Statut</th>
                      <th>Localisation</th>
                      <th>Date mise en service</th>
                      <th>Intervention</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr *ngFor="let it of selectedStockDetails.enServiceItems">
                      <td>{{ it.statut }}</td>
                      <td>{{ it.localisation || '-' }}</td>
                      <td>{{ it.dateMiseEnService || '-' }}</td>

                      <td>
                        <button
                          *ngIf="it.interventionId"
                          type="button"
                          class="resp-btn-ghost"
                          (click)="openInterventionDetails(it.interventionId)"
                        >
                          <span class="material-icons">visibility</span>
                          <span>Voir intervention</span>
                        </button>

                        <span *ngIf="!it.interventionId" class="resp-muted">-</span>
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div *ngIf="!selectedStockDetails.enServiceItems?.length" class="resp-muted" style="margin-top: 12px;">
                Aucun exemplaire en service.
              </div>


              <div *ngIf="!selectedStockDetails.enServiceItems?.length"
                   class="resp-muted" style="margin-top: 12px;">
                Aucun exemplaire trouv√©.
              </div>
            </ng-container>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" type="button" (click)="closeStockDetailsModal()">
              Fermer
            </button>
          </div>
        </div>
      </div>


      <!-- ===== MODAL D√âTAILS TECHNICIEN ===== -->
      <div
        class="modal-backdrop"
        *ngIf="showTechnicienModal && selectedTechnicien"
      >
        <div class="modal">
          <div class="modal-header">
            <h2>D√©tails du technicien</h2>
            <button class="icon-btn" (click)="closeTechnicienModal()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body details-body" *ngIf="selectedTechnicien as tech">

            <!-- ‚úÖ ENT√äTE TECH (UNE SEULE FOIS) -->
            <h3 class="details-title">{{ tech.nom }}</h3>

            <p class="details-meta">
              <strong>{{ tech.categorie }}</strong> ¬∑
              <span class="resp-tech-badge" [ngClass]="tech.disponible ? 'dispo' : 'non-dispo'">
      <span class="resp-tech-dot"></span>
                {{ tech.disponible ? 'Disponible' : 'Occup√©' }}
    </span>
            </p>

            <!-- ‚úÖ Messages chargement / erreur (au bon endroit) -->
            <div *ngIf="loadingTechInterventions" class="details-meta">
              Chargement des interventions...
            </div>

            <div *ngIf="errorTechInterventions" class="details-meta" style="color:#b91c1c;">
              {{ errorTechInterventions }}
            </div>

            <!-- ‚úÖ CONTENU -->
            <div class="details-grid">
              <div class="details-item">
                <span class="details-label">Sp√©cialit√©s</span>
                <p class="details-description">
                  {{ (tech.specialites?.length ? tech.specialites : ['‚Äî']).join(' ¬∑ ') }}
                </p>
              </div>

              <div class="details-item">
                <span class="details-label">Interventions en cours</span>
                <ul class="details-description">
                  <li *ngIf="(tech.interventionsEnCours || []).length === 0">
                    Aucune intervention en cours.
                  </li>
                  <li *ngFor="let inter of tech.interventionsEnCours || []">
                    {{ inter.titre }} ‚Äì {{ inter.lieu }} ({{ inter.statut }})
                  </li>
                </ul>
              </div>

              <div class="details-item details-full">
                <span class="details-label">Derni√®res interventions</span>
                <ul class="details-description">
                  <li *ngIf="(tech.dernieresInterventions || []).length === 0">
                    Aucune intervention r√©cente.
                  </li>
                  <li *ngFor="let inter of tech.dernieresInterventions || []">
                    {{ inter.titre }}

                    <ng-container *ngIf="inter.dateDebut">
                      . Le {{ inter.dateDebut | date:'dd/MM/yyyy' }}
                    </ng-container>

                    <ng-container *ngIf="inter.resultat">
                      &nbsp;‚Äì {{ inter.resultat }}
                    </ng-container>
                  </li>

                </ul>
              </div>
            </div>
          </div>


          <div class="modal-footer">
            <button class="secondary-btn" (click)="closeTechnicienModal()">
              Fermer
            </button>
          </div>
        </div>
      </div>

      <!-- ‚úÖ LIGHTBOX -->
      <div
        class="lightbox-backdrop"
        *ngIf="isImageLightboxOpen"
        (click)="closeImageLightbox()"
      >
        <div class="lightbox-content" (click)="$event.stopPropagation()">
          <button class="lightbox-close" type="button" (click)="closeImageLightbox()">
            ‚úï
          </button>

          <img
            class="lightbox-image"
            [src]="lightboxImageSrc!"
            alt="Zoom image panne"
          />
        </div>
      </div>

      <!-- ===== MODAL D√âTAILS MAINTENANCE PR√âVENTIVE ===== -->
      <div
        class="modal-backdrop"
        *ngIf="showPreventiveDetails && selectedPreventive"
      >
        <div class="modal">
          <div class="modal-header">
            <h2>D√©tails de la maintenance pr√©ventive</h2>
            <button class="icon-btn" (click)="closePreventiveDetails()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body details-body">
            <h3 class="details-title">
              {{ selectedPreventive?.typeEquipement }} ‚Äì
              {{ selectedPreventive?.frequence }}
            </h3>
            <p class="details-meta">
              Prochaine date :
              {{ selectedPreventive?.prochaineDate | date: 'yyyy-MM-dd' }}
              ¬∑ Responsable :
              <strong>{{ selectedPreventive?.responsable }}</strong>
            </p>

            <div class="details-grid">
              <div class="details-item">
                <span class="details-label">√âquipement</span>
                <span class="details-value">
                  {{ selectedPreventive?.equipementReference || 'Non pr√©cis√©' }}
                </span>
              </div>

              <div class="details-item">
                <span class="details-label">Fr√©quence</span>
                <span class="details-value">
                  {{ selectedPreventive?.frequence }}
                </span>
              </div>

              <div class="details-item">
                <span class="details-label">Statut</span>
                <span
                  class="resp-status-badge"
                  [ngClass]="{
                    'resp-status-en-attente':
                      selectedPreventive?.statut === 'PLANIFIEE',
                    'resp-status-en-cours':
                      selectedPreventive?.statut === 'EN_RETARD',
                    'resp-status-resolue':
                      selectedPreventive?.statut === 'REALISEE'
                  }"
                >
                  {{
                    selectedPreventive?.statut === 'PLANIFIEE'
                      ? 'Planifi√©e'
                      : selectedPreventive?.statut === 'EN_RETARD'
                        ? 'En retard'
                        : 'R√©alis√©e'
                  }}
                </span>
              </div>
              <div class="details-item">
                <span class="details-label">Technicien affect√©</span>
                <div class="details-value">
                  {{ selectedPreventiveTechnicienLabel }}
                </div>
              </div>


              <div class="details-item details-full">
                <span class="details-label">Description</span>
                <p class="details-description">
                  {{
                    selectedPreventive?.description ||
                    'Aucune description fournie.'
                  }}
                </p>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" (click)="closePreventiveDetails()">
              Fermer
            </button>
          </div>
        </div>
      </div>

      <!-- ========================= -->
      <!-- MODALE : DETAILS INTERVENTION -->
      <!-- ========================= -->
      <div class="modal-backdrop" *ngIf="showInterventionDetailsModal">
        <div class="modal">
          <div class="modal-header">
            <h2>D√©tails de l‚Äôintervention</h2>

            <button class="icon-btn" type="button" (click)="closeInterventionDetailsModal()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body">
            <div *ngIf="loadingInterventionDetails" class="resp-muted">
              Chargement...
            </div>

            <div *ngIf="!loadingInterventionDetails && errorInterventionDetails" class="resp-error">
              {{ errorInterventionDetails }}
            </div>

            <ng-container *ngIf="!loadingInterventionDetails && !errorInterventionDetails && selectedInterventionDetails">
              <h3 class="details-title">
                {{ selectedInterventionDetails.titre || ('Intervention #' + selectedInterventionDetails.id) }}
              </h3>

              <div class="details-grid">
                <div class="details-item">
                  <span class="details-label">Statut</span>
                  <span class="details-value">{{ selectedInterventionDetails.statut }}</span>
                </div>

                <div class="details-item">
                  <span class="details-label">Type</span>
                  <span class="details-value">{{ selectedInterventionDetails.type }}</span>
                </div>

                <div class="details-item">
                  <span class="details-label">D√©but</span>
                  <span class="details-value">{{ selectedInterventionDetails.dateDebut || '-' }}</span>
                </div>

                <div class="details-item">
                  <span class="details-label">Fin</span>
                  <span class="details-value">{{ selectedInterventionDetails.dateFin || '-' }}</span>
                </div>

                <div class="details-item details-full" *ngIf="selectedInterventionDetails.description">
                  <span class="details-label">Description</span>
                  <p class="details-description">{{ selectedInterventionDetails.description }}</p>
                </div>
              </div>
            </ng-container>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" type="button" (click)="closeInterventionDetailsModal()">
              Fermer
            </button>
          </div>
        </div>
      </div>


      <!-- ===== MODAL CONFIRMATION D√âCONNEXION (NOUVEAU DESIGN) ===== -->
      <div class="modal-backdrop logout-backdrop" *ngIf="showLogoutConfirm">
        <div class="modal logout-modal" (click)="$event.stopPropagation()">
          <!-- Bouton X en haut √† droite -->
          <button
            class="logout-close-btn"
            type="button"
            aria-label="Fermer"
            (click)="cancelLogoutConfirm()"
          >
            <span class="material-icons">close</span>
          </button>

          <!-- Ic√¥ne d‚Äôalerte -->
          <div class="logout-icon-wrapper">
            <div class="logout-icon-circle">
              <span class="material-icons">error_outline</span>
            </div>
          </div>

          <!-- Titre + texte -->
          <h2 class="logout-title">Confirmer la d√©connexion</h2>
          <p class="logout-text">
            Voulez-vous vraiment continuer&nbsp;?
          </p>

          <!-- Boutons d‚Äôaction -->
          <div class="logout-actions">
            <button
              type="button"
              class="btn-logout-secondary"
              (click)="cancelLogoutConfirm()"
            >
              Annuler
            </button>

            <button
              type="button"
              class="btn-logout-danger"
              (click)="confirmLogout()"
            >
              Se d√©connecter
            </button>
          </div>
        </div>
      </div>

      <!-- ===== MODAL NOUVELLE MAINTENANCE PR√âVENTIVE ===== -->
      <div class="modal-backdrop" *ngIf="showPreventiveForm">
        <div class="modal">
          <div class="modal-header">
            <h2>Nouvelle maintenance pr√©ventive</h2>
            <button class="icon-btn" type="button" (click)="closePreventiveForm()">
              <span class="material-icons">close</span>
            </button>
          </div>

          <div class="modal-body">
            <div class="details-grid">
              <!-- √âquipement -->
              <div class="details-item">
                <span class="details-label">√âquipement <span class="req">*</span></span>
                <select
                  class="select-field"
                  name="equipementReference"
                  [(ngModel)]="newPreventive.equipementReference"
                  required
                >
                  <option [ngValue]="null" disabled>Choisissez un √©quipement</option>
                  <option *ngFor="let e of equipementOptions" [ngValue]="e">
                    {{ e }}
                  </option>
                </select>
              </div>

              <!-- Technicien affect√© -->
              <div class="details-item">
                <span class="details-label">Technicien affect√© <span class="req">*</span></span>

                <!-- Loading / erreur (optionnel mais propre) -->
                <div *ngIf="loadingTechniciens" class="hint-text">Chargement des techniciens...</div>
                <div *ngIf="!loadingTechniciens && techniciens?.length === 0" class="hint-text">
                  Impossible de charger la liste des techniciens.
                </div>

                <select
                  class="select-field"
                  name="technicienId"
                  [(ngModel)]="modalTechnicienId"
                  required
                  [disabled]="loadingTechniciens || (techniciens?.length === 0)"
                >
                  <option [ngValue]="null" disabled>Choisissez un technicien</option>

                  <option *ngFor="let t of techniciens" [ngValue]="t.id">
                    {{ t.nom }}
                    <ng-container *ngIf="t.serviceUnite"> ({{ t.serviceUnite }})</ng-container>
                    <ng-container *ngIf="!t.serviceUnite && t.categorie"> ({{ t.categorie }})</ng-container>
                  </option>

                </select>
              </div>

              <!-- Fr√©quence -->
              <div class="details-item">
                <span class="details-label">Fr√©quence <span class="req">*</span></span>
                <select
                  class="select-field"
                  name="frequence"
                  [(ngModel)]="newPreventive.frequence"
                  required
                >
                  <option [ngValue]="null" disabled>Choisir une fr√©quence</option>
                  <option [ngValue]="'Mensuelle'">Mensuelle</option>
                  <option [ngValue]="'Trimestrielle'">Trimestrielle</option>
                  <option [ngValue]="'Semestrielle'">Semestrielle</option>
                  <option [ngValue]="'Annuelle'">Annuelle</option>
                </select>
              </div>

              <!-- Prochaine date -->
              <div class="details-item">
                <span class="details-label">Prochaine date <span class="req">*</span></span>
                <input
                  type="date"
                  class="input-field"
                  name="prochaineDate"
                  [(ngModel)]="newPreventive.prochaineDate"
                  required
                />
              </div>

              <!-- Responsable -->
              <div class="details-item">
                <span class="details-label">Responsable</span>
                <input
                  type="text"
                  class="input-field"
                  name="responsable"
                  [(ngModel)]="newPreventive.responsable"
                  [readonly]="true"
                />
              </div>

              <!-- Description -->
              <div class="details-item details-full">
                <span class="details-label">Description <span class="req">*</span></span>
                <textarea
                  class="textarea-field"
                  rows="3"
                  name="description"
                  [(ngModel)]="newPreventive.description"
                  required
                ></textarea>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="secondary-btn" type="button" (click)="closePreventiveForm()">
              Annuler
            </button>
            <button
              class="primary-btn"
              type="button"
              [disabled]="!isNewPreventiveValid || loadingPreventives"
              (click)="saveNewPreventive()"
            >
              Enregistrer
            </button>
          </div>
        </div>
      </div>
      <!-- ===== FIN MODAL NOUVELLE MAINTENANCE PR√âVENTIVE ===== -->


    </section>
  </main>
</div>

<!--HZGZGZGZGZZGZGZGZZGZG-->
